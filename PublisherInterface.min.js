var e,t,r,i,o,n,s,c,a,d,l,h,u={};e=u,t="PublisherInterface",r=()=>V,i=e=>V=e,Object.defineProperty(e,t,{get:r,set:i,enumerable:!0,configurable:!0}),(n=o||(o={})).Call="call",n.Reply="reply",n.Syn="syn",n.SynAck="synAck",n.Ack="ack",(c=s||(s={})).Fulfilled="fulfilled",c.Rejected="rejected",(d=a||(a={})).ConnectionDestroyed="ConnectionDestroyed",d.ConnectionTimeout="ConnectionTimeout",d.NoIframeSrc="NoIframeSrc",(l||(l={})).DataCloneError="DataCloneError",(h||(h={})).Message="message";var f=(e,t)=>{const r=[];let i=!1;return{destroy(o){i||(i=!0,t(`${e}: Destroying connection`),r.forEach((e=>{e(o)})))},onDestroy(e){i?e():r.push(e)}}},g=e=>(...t)=>{e&&console.log("[Penpal]",...t)};const v={"http:":"80","https:":"443"},w=/^(https?:)?\/\/([^/:]+)?(:(\d+))?/,m=["file:","data:"];var E=e=>{if(e&&m.find((t=>e.startsWith(t))))return"null";const t=document.location,r=w.exec(e);let i,o,n;r?(i=r[1]?r[1]:t.protocol,o=r[2],n=r[4]):(i=t.protocol,o=t.hostname,n=t.port);return`${i}//${o}${n&&n!==v[i]?`:${n}`:""}`};const p=({name:e,message:t,stack:r})=>({name:e,message:t,stack:r}),b=e=>{const t=new Error;return Object.keys(e).forEach((r=>t[r]=e[r])),t};var y=(e,t,r)=>{const{localName:i,local:n,remote:c,originForSending:a,originForReceiving:d}=e;let u=!1;const f=e=>{if(e.source!==c||e.data.penpal!==o.Call)return;if("*"!==d&&e.origin!==d)return void r(`${i} received message from origin ${e.origin} which did not match expected origin ${d}`);const n=e.data,{methodName:h,args:f,id:g}=n;r(`${i}: Received ${h}() call`);const v=e=>t=>{if(r(`${i}: Sending ${h}() reply`),u)return void r(`${i}: Unable to send ${h}() reply due to destroyed connection`);const n={penpal:o.Reply,id:g,resolution:e,returnValue:t};e===s.Rejected&&t instanceof Error&&(n.returnValue=p(t),n.returnValueIsError=!0);try{c.postMessage(n,a)}catch(e){if(e.name===l.DataCloneError){const t={penpal:o.Reply,id:g,resolution:s.Rejected,returnValue:p(e),returnValueIsError:!0};c.postMessage(t,a)}throw e}};new Promise((e=>e(t[h].apply(t,f)))).then(v(s.Fulfilled),v(s.Rejected))};return n.addEventListener(h.Message,f),()=>{u=!0,n.removeEventListener(h.Message,f)}};let S=0;const P=e=>e?e.split("."):[],j=(e,t,r)=>{const i=P(t);return i.reduce(((e,t,o)=>(void 0===e[t]&&(e[t]={}),o===i.length-1&&(e[t]=r),e[t])),e),e},k=(e,t)=>{const r={};return Object.keys(e).forEach((i=>{const o=e[i],n=((e,t)=>{const r=P(t||"");return r.push(e),(e=>e.join("."))(r)})(i,t);"object"==typeof o&&Object.assign(r,k(o,n)),"function"==typeof o&&(r[n]=o)})),r},A=e=>{const t={};for(const r in e)j(t,r,e[r]);return t};var F=(e,t,r,i,n)=>{const{localName:c,local:d,remote:l,originForSending:u,originForReceiving:f}=t;let g=!1;n(`${c}: Connecting call sender`);const v=e=>(...t)=>{let r;n(`${c}: Sending ${e}() call`);try{l.closed&&(r=!0)}catch(e){r=!0}if(r&&i(),g){const t=new Error(`Unable to send ${e}() call due to destroyed connection`);throw t.code=a.ConnectionDestroyed,t}return new Promise(((r,i)=>{const a=++S,g=t=>{if(t.source!==l||t.data.penpal!==o.Reply||t.data.id!==a)return;if("*"!==f&&t.origin!==f)return void n(`${c} received message from origin ${t.origin} which did not match expected origin ${f}`);const u=t.data;n(`${c}: Received ${e}() reply`),d.removeEventListener(h.Message,g);let v=u.returnValue;u.returnValueIsError&&(v=b(v)),(u.resolution===s.Fulfilled?r:i)(v)};d.addEventListener(h.Message,g);const v={penpal:o.Call,id:a,methodName:e,args:t};l.postMessage(v,u)}))},w=r.reduce(((e,t)=>(e[t]=v(t),e)),{});return Object.assign(e,A(w)),()=>{g=!0}},I=(e,t,r,i,o)=>{const{destroy:n,onDestroy:s}=i;let c,a;const d={};return i=>{if("*"!==t&&i.origin!==t)return void o(`Parent: Handshake - Received ACK message from origin ${i.origin} which did not match expected origin ${t}`);o("Parent: Handshake - Received ACK");const l={localName:"Parent",local:window,remote:i.source,originForSending:r,originForReceiving:t};c&&c(),c=y(l,e,o),s(c),a&&a.forEach((e=>{delete d[e]})),a=i.data.methodNames;const h=F(d,l,a,n,o);return s(h),d}},$=(e,t,r,i)=>n=>{if(!n.source)return;if("*"!==r&&n.origin!==r)return void e(`Parent: Handshake - Received SYN message from origin ${n.origin} which did not match expected origin ${r}`);e("Parent: Handshake - Received SYN, responding with SYN-ACK");const s={penpal:o.SynAck,methodNames:Object.keys(t)};n.source.postMessage(s,i)};var C=(e,t)=>{const{destroy:r,onDestroy:i}=t,o=setInterval((()=>{e.isConnected||(clearInterval(o),r())}),6e4);i((()=>{clearInterval(o)}))},L=(e,t)=>{let r;return void 0!==e&&(r=window.setTimeout((()=>{const r=new Error(`Connection timed out after ${e}ms`);r.code=a.ConnectionTimeout,t(r)}),e)),()=>{clearTimeout(r)}},N=e=>{if(!e.src&&!e.srcdoc){const e=new Error("Iframe must have src or srcdoc property defined.");throw e.code=a.NoIframeSrc,e}},x=e=>{let{iframe:t,methods:r={},childOrigin:i,timeout:n,debug:s=!1}=e;const c=g(s),a=f("Parent",c),{onDestroy:d,destroy:l}=a;i||(N(t),i=E(t.src));const u="null"===i?"*":i,v=k(r),w=$(c,v,i,u),m=I(v,i,u,a,c);return{promise:new Promise(((e,r)=>{const i=L(n,l),s=r=>{if(r.source===t.contentWindow&&r.data)if(r.data.penpal!==o.Syn)if(r.data.penpal!==o.Ack);else{const t=m(r);t&&(i(),e(t))}else w(r)};window.addEventListener(h.Message,s),c("Parent: Awaiting handshake"),C(t,a),d((e=>{window.removeEventListener(h.Message,s),e&&r(e)}))})),destroy(){l()}}};var R,D=function(e,t,r,i){return new(r||(r=Promise))((function(o,n){function s(e){try{a(i.next(e))}catch(e){n(e)}}function c(e){try{a(i.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((i=i.apply(e,t||[])).next())}))},O=function(e,t,r,i){if("a"===r&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)},M=function(e,t,r,i,o){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?o.call(e,r):o?o.value=r:t.set(e,r),r};class V{constructor(){this.chiliEventListenerCallbacks=new Map,R.set(this,null)}static build(e,t={}){return D(this,void 0,void 0,(function*(){const r=new V;r.child=yield x({iframe:e,methods:{handleEvents:r.handleEvents.bind(r)},timeout:t.timeout,debug:t.penpalDebug}).promise;const i=t.events;if(null!=i&&i.length>0)for(const e of i)"string"==typeof e?r.addListener(e):r.addListener(e.name,e.func);return r}))}handleEvents(e,t){var r;return this.chiliEventListenerCallbacks.has(e)&&(null===(r=this.chiliEventListenerCallbacks.get(e))||void 0===r||r(t)),e}get editorObject(){return null==O(this,R,"f")&&M(this,R,{Alert:this.alert.bind(this),GetDirtyState:this.getDirtyState.bind(this),NextPage:this.nextPage.bind(this),PreviousPage:this.previousPage.bind(this),SetSelectedPage:this.setSelectedPage.bind(this),GetSelectedPage:this.getSelectedPage.bind(this),GetSelectedPageName:this.getSelectedPageName.bind(this),GetNumPages:this.getNumPages.bind(this),RemoveListener:this.removeListener.bind(this),AddListener:this.addListener.bind(this),GetObject:this.getObject.bind(this),SetProperty:this.setProperty.bind(this),ExecuteFunction:this.executeFunction.bind(this),GetPageSnapshot:this.getPageSnapshot.bind(this),GetFrameSnapshot:this.getFrameSnapshot.bind(this),GetFrameSubjectArea:this.getFrameSubjectArea.bind(this),SetFrameSubjectArea:this.setFrameSubjectArea.bind(this),ClearFrameSubjectArea:this.clearFrameSubjectArea.bind(this),GetAssetSubjectInfo:this.getAssetSubjectInfo.bind(this),SetAssetSubjectInfo:this.setAssetSubjectInfo.bind(this),ClearAssetSubjectInfo:this.clearAssetSubjectInfo.bind(this),SetVariableIsLocked:this.setVariableIsLocked.bind(this)},"f"),O(this,R,"f")}alert(e,t){return D(this,void 0,void 0,(function*(){const r=yield this.child.alert(e,t);if(r.isError)throw new Error(r.error)}))}getDirtyState(){return D(this,void 0,void 0,(function*(){const e=yield this.child.getDirtyState();if(e.isError)throw new Error(e.error);return e.ok}))}nextPage(){return D(this,void 0,void 0,(function*(){const e=yield this.child.nextPage();if(e.isError)throw new Error(e.error)}))}previousPage(){return D(this,void 0,void 0,(function*(){const e=yield this.child.previousPage();if(e.isError)throw new Error(e.error)}))}setSelectedPage(e){return D(this,void 0,void 0,(function*(){const t=yield this.child.setSelectedPage(e);if(t.isError)throw new Error(t.error)}))}getSelectedPage(){return D(this,void 0,void 0,(function*(){const e=yield this.child.getSelectedPage();if(e.isError)throw new Error(e.error);return e.ok}))}getSelectedPageName(){return D(this,void 0,void 0,(function*(){const e=yield this.child.getSelectedPageName();if(e.isError)throw new Error(e.error);return e.ok}))}getNumPages(){return D(this,void 0,void 0,(function*(){const e=yield this.child.getNumPages();if(e.isError)throw new Error(e.error);return e.ok}))}removeListener(e){return D(this,void 0,void 0,(function*(){this.chiliEventListenerCallbacks.delete(e);const t=yield this.child.removeListener(e);if(t.isError)throw new Error(t.error)}))}addListener(e,t){return D(this,void 0,void 0,(function*(){this.chiliEventListenerCallbacks.set(e,null==t?t=>{null!=window.OnEditorEvent&&window.OnEditorEvent(e,t)}:t);const r=yield this.child.addListener(e);if(r.isError)throw new Error(r.error)}))}getObject(e){return D(this,void 0,void 0,(function*(){const t=yield this.child.getObject(e);if(t.isError)throw new Error(t.error);return t.ok}))}getObjects(e){return D(this,void 0,void 0,(function*(){const t=yield this.child.getObjects(e);if(t.isError)throw new Error(t.error);return t.ok}))}setProperty(e,t,r){return D(this,void 0,void 0,(function*(){const i=yield this.child.setProperty(e,t,r);if(i.isError)throw new Error(i.error)}))}setProperties(e){return D(this,void 0,void 0,(function*(){const t=yield this.child.setProperties(e);if(t.isError)throw new Error(t.error)}))}executeFunction(e,t,...r){return D(this,void 0,void 0,(function*(){const i=yield this.child.executeFunction(e,t,r);if(i.isError)throw new Error(i.error);return i.ok}))}executeFunctions(e){return D(this,void 0,void 0,(function*(){const t=yield this.child.executeFunctions(e);if(t.isError)throw new Error(t.error);return t.ok}))}getPageSnapshot(e,t,r,i,o,n){return D(this,void 0,void 0,(function*(){const s=yield this.child.getPageSnapshot(e,t,r,i,o,n);if(s.isError)throw new Error(s.error);return s.ok}))}getFrameSnapshot(e,t,r){return D(this,void 0,void 0,(function*(){const i=yield this.child.getFrameSnapshot(e,t,r);if(i.isError)throw new Error(i.error);return i.ok}))}getFrameSubjectArea(e){return D(this,void 0,void 0,(function*(){const t=yield this.child.getFrameSubjectArea(e);if(t.isError)throw new Error(t.error);return t.ok}))}setFrameSubjectArea(e,t,r,i,o){return D(this,void 0,void 0,(function*(){const n=yield this.child.setFrameSubjectArea(e,t,r,i,o);if(n.isError)throw new Error(n.error)}))}clearFrameSubjectArea(e){return D(this,void 0,void 0,(function*(){const t=yield this.child.clearFrameSubjectArea(e);if(t.isError)throw new Error(t.error)}))}getAssetSubjectInfo(e){return D(this,void 0,void 0,(function*(){const t=yield this.child.getAssetSubjectInfo(e);if(t.isError)throw new Error(t.error);return t.ok}))}setAssetSubjectInfo(e,t,r,i,o,n,s){return D(this,void 0,void 0,(function*(){const c=yield this.child.setAssetSubjectInfo(e,t,r,i,o,n,s);if(c.isError)throw new Error(c.error)}))}clearAssetSubjectInfo(e){return D(this,void 0,void 0,(function*(){const t=yield this.child.clearAssetSubjectInfo(e);if(t.isError)throw new Error(t.error)}))}setVariableIsLocked(e,t){return D(this,void 0,void 0,(function*(){const r=yield this.child.setVariableIsLocked(e,t);if(r.isError)throw new Error(r.error)}))}}R=new WeakMap;export{V as PublisherInterface,u as default};
//# sourceMappingURL=PublisherInterface.min.js.map
